\chapter{Modelling} \label{ch:modelling}
To make the segway able to balance in an upright position and be able to drive as well, it is necessary to have a model of the system, to understand how the system behaves from a physical and mathematical perspective. In this chapter, this model will be derived. A model is a mathematical description of the system's behaviour, in this case both the electrical and mechanical parts of the system.
This is needed to design a controller for the system. %The model will al be used for verifying the controller before it is implemented in the real system, and 
%From the model, the controllertype can be determinedm depending on the system type.
\begin{figure}[H]
\centering
\scalebox{0.8}{
\input{figures/modelBlock.rasmus}
}
\caption{Feedback loop of a system, with the plant, G, highlighted.}
\label{fig:modelBlock}
\end{figure}
\vspace{-0.8 cm}
Looking at a general feedback loop, see \autoref{fig:modelBlock}, it consists of three blocks. A controller, $D$, a plant that to be controlled, $G$, and sensors, $H$. The control loop also features a reference signal, $R$, an error signal, $E$, the control signal, $U$, between the controller and the plant, and an output, $Y$. It is the model of the plant, that is to be determined in this chapter, as highlighted in \autoref{fig:modelBlock}.
\section{Modelling overview \label{sec:modelover}}
The segway can be described as an inverted pendulum, the cart can be moved by a motorized two-wheeled system in order to stabilize the segway in an upright position. 
\begin{figure}[H]
\centering
\includegraphics[width=0.25\textwidth]{/invertedPendulumModel.pdf}
\caption{An overall diagram of the segway.}
\label{fig:invertedPendulumModel}
\end{figure}
\vspace{-2em}
A figure of the segway with the cart mass, $m_c$, and inverted pendulum mass, $m_p$, can be seen in \autoref{fig:invertedPendulumModel}. Here, the inverted pendulum's tilting angle is represented by $\theta_p$, it can be further noted that the wheel's angle is denoted $\theta_w$.\\
The model of the segway is split in two smaller models, which is a model for the motor and wheel, and a model for the cart and inverted pendulum. These two models are later combined into a model for the segway. The splitting of the model can be seen in \autoref{fig:modelOverall}, together with the interfaces between the models.
\begin{figure}[H]
\centering
\input{figures/overallModel.rasmus}
\caption{The plant in the feedback loop. Within it is a motor and wheel model and a model for the inverted pendulum.}
\label{fig:modelOverall}
\end{figure}
\vspace{-2em}
The input to the system is the voltage applied to the motors, $V_a$. This voltage is controlled by simply changing the PWM duty cycle that controls the motors. In practice, this is equal to changing the motor input voltage. The interface signal between the motor and wheel model and the model describing the cart's movement is the torque applied by the motors to the cart, $\tau_a(t)$. Based on this torque, an expression for the force $F_F(t)$ can be made, which is the force that makes the segway move either forward or backwards.
The interface between the cart and the inverted pendulum is chosen to be the the angle of the wheels, $\theta_w$, as they determine the position of the segway. %This is the applied force to the segway, that makes it move. 
%The applied force, $F_F$,  is generated by the motors and wheels, and is what makes the segway move.\\
The model of the inverted pendulum has this angle, $\theta_w$ as input and the angle of the inverted pendulum, $\theta_p$, as output. Also, a load force $F_L(t)$ is inserted from the inverted pendulum to the cart model, as the tilting of the pendulum makes the cart move. % From the wheel angle, $\theta_w$, it is possible to set up an expression for the force that the wheels apply to the segway, named $F_F$, as this is used in the segway model.
%The reason why $F_F$ is chosen as the interface between the two smaller models is because it is usually such an input force that is used when modelling an inverted pendulum, see e.g. \citep{InvertedPendulumMathworks}. It will therefore be easy to put up a free body diagram of the inverted pendulum, since the contribution from the base to the pendulum is a force, easily included in the diagram.
\\\\
In this chapter, an expression for the motor and wheel model will be derived. Afterwards, a model of the cart and inverted pendulum is derived, see \autoref{fig:modelOverall}. These models will be simulated and verified, before being combined. Lastly the system model is simulated and verified. To be able to design a controller for the system, this model is then linearised and Laplace transformed to allow a transfer function to be derived, which is the final step performed in this chapter. %The transfer function of the system is the output of this chapter. \\
Firstly the motors and wheels model is to be derived in the following section. 
% From the model of the motors and wheels, a transfer function can be derived for the system. This transfer function can be be combined with a transfer function for the inverted pendulum, resulting in a transfer function for the entire plant.
%Thus the model transfer function can be described as a product of the partial system transfer functions:
%\begin{equation}
%G(s) = \frac{\theta_p(s)}{V_a(s)} = \frac{F_F(s)}{V_a(s)} \cdot \frac{\theta_p(s)}{F_F(s)}
%\label{eq:Gs_segway}
%\end{equation}
%
%\begin{where}
%\va{$G(s)$}{is the plant transfer function}{rad/V}
%\va{$V_a(s)$}{is the input voltage}{V}
%\va{$F_F(s)$}{is forward force}{N}
%\va{$\theta_p(s)$}{is the pendulum tilting angle}{rad}
%\end{where}
%\newpar
%Now that the model has been split up into two, each model will be separately derived. This is done in the following sections, starting with the motors and wheels model.
%The first step to create a control system for the segway is to model all the electrical and mechanical parts of the segway. The model determines how the segway behaves and can help to predict how it will react when a force or input is applied to different parts. The modelling of the segway is divided into two sections:% as seen on \autoref{fig:modelling_overview}.

%\begin{itemize}
%\item Modelling of the motors and wheels.
%\item Modelling of the inverted pendulum.
%\end{itemize}

%\begin{figure}[H]
%	\centering
%	\includegraphics[width=0.7\textwidth]{design/figures/modelling/modelling_intro_block.pdf}
%	\caption{The division of the modelling.}
%	\label{fig:modelling_overview}
%\end{figure}

%The two sections are modelling of the inverted pendulum and modelling of the motors and wheels. The first part will consist of a modelling of the motors and wheels and the second part is the inverted pendulum. 

\input{design/modelling/motor.tex}
%\input{design/modelling/parameterEstimationMotor.tex}
\input{design/modelling/Inv_pen_model.tex}
%\input{design/modelling/Inv_pen_model_non_lin.tex}
\input{design/modelling/pen_linear.tex}
%\input{design/modelling/Laplace_transform.tex}
%\input{design/modelling/merging_model.tex}
%\input{design/modelling/eqofmotion.tex}
%The motors and wheels applies a force to the pendulum based 



%As mentioned before the inverted pendulum is an unstable system and a model is needed to describe the 